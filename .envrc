# codex cli のUserフォルダを指定
export CODEX_HOME_RELATIVE=.codex
export CODEX_HOME_ABSOLUTE=$PWD/$CODEX_HOME_RELATIVE
export CODEX_HOME=$CODEX_HOME_ABSOLUTE

# codex cli のUserフォルダがなければ作成する
if [ ! -d "$CODEX_HOME" ]; then
  mkdir -p "$CODEX_HOME"
fi

# .gitignore がなければ作成する
if [ ! -f "$PWD/.gitignore" ]; then
  touch "$PWD/.gitignore"
fi

# codex cli 用の個人用設定ファイルへのシンボリックリンクを作成する
CODEX_SYMLINK_FILES="
AGENTS.md
auth.json
"

for name in $CODEX_SYMLINK_FILES; do
  dest="$CODEX_HOME/$name"
  src="$HOME/.codex/$name"
  if [ -e "$src" ] && [ ! -e "$dest" ] && [ ! -L "$dest" ]; then
    ln -s "$src" "$dest"
  fi
done

# codex cli 用の個人用設定ファイルをコピーしてくる
CODEX_COPY_FILES="
config.toml
"

for name in $CODEX_COPY_FILES; do
  dest="$CODEX_HOME/$name"
  src="$HOME/.codex/$name"
  if [ -e "$src" ] && [ ! -e "$dest" ] && [ ! -L "$dest" ]; then
    cp "$src" "$dest"
  fi
done

# codex 用のキャッシュファイルを git 管理外とする
CODEX_GITIGNORE_ENTRIES="
/$CODEX_HOME_RELATIVE/AGENTS.md
/$CODEX_HOME_RELATIVE/auth.json
/$CODEX_HOME_RELATIVE/history.jsonl
/$CODEX_HOME_RELATIVE/log/
/$CODEX_HOME_RELATIVE/models_cache.json
/$CODEX_HOME_RELATIVE/.personality_migration
/$CODEX_HOME_RELATIVE/shell_snapshots/
/$CODEX_HOME_RELATIVE/skills/.system/
/$CODEX_HOME_RELATIVE/tmp/
/$CODEX_HOME_RELATIVE/version.json
"

for entry in $CODEX_GITIGNORE_ENTRIES; do
  if command -v rg >/dev/null 2>&1; then
    exists_in_gitignore() {
      rg -q -x --fixed-strings "$1" "$PWD/.gitignore"
    }
  else
    exists_in_gitignore() {
      grep -Fqx -- "$1" "$PWD/.gitignore"
    }
  fi

  if ! exists_in_gitignore "$entry"; then
    printf "%s\n" "$entry" >> "$PWD/.gitignore"
  fi
done

# DEVS_MANAGED_BEGIN
if [ -x "$PWD/.envrc.assets/apply.sh" ]; then
  "$PWD/.envrc.assets/apply.sh" --quiet
fi
source_env "$PWD/.envrc.assets/envrc.managed"
# DEVS_MANAGED_END
